// Carrozzeria Fagioli MVP - Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// Customers (vehicle owners)
model Customer {
  id        String   @id @default(uuid())
  phone     String
  email     String?
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vehicles Vehicle[]
  repairs  Repair[]
}

// Vehicles
model Vehicle {
  id         String   @id @default(uuid())
  plate      String   @unique
  brand      String?
  model      String?
  year       Int?
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  repairs Repair[]
}

// Repairs (core entity)
model Repair {
  id           String  @id @default(uuid())
  trackingCode String  @unique // ABC123 - short code for tracking URL
  vehicleId    String?
  vehicle      Vehicle? @relation(fields: [vehicleId], references: [id])
  customerId   String?
  customer     Customer? @relation(fields: [customerId], references: [id])

  // Repair type
  repairType String // 'sinistro', 'estetica', 'meccanica'

  // Insurance info (if sinistro)
  insuranceCompany String?
  policyNumber     String?

  // Status workflow
  status String @default("pre_checkin")
  // Statuses: pre_checkin, confirmed, accepted, disassembly,
  //           bodywork, painting, reassembly, quality_check, ready, delivered

  // Dates
  preferredDate  DateTime?
  preferredTime  String?
  confirmedDate  DateTime?
  confirmedTime  String?
  estimatedCompletion DateTime?
  actualCompletion    DateTime?

  // Notes
  notes       String?
  staffNotes  String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  photos        Photo[]
  statusHistory StatusHistory[]
}

// Photos uploaded by customer
model Photo {
  id        String   @id @default(uuid())
  repairId  String
  repair    Repair   @relation(fields: [repairId], references: [id], onDelete: Cascade)
  photoType String   // 'front', 'rear', 'left', 'right', 'detail', 'cai'
  filename  String
  url       String
  createdAt DateTime @default(now())
}

// Status change history for tracking
model StatusHistory {
  id        String   @id @default(uuid())
  repairId  String
  repair    Repair   @relation(fields: [repairId], references: [id], onDelete: Cascade)
  status    String
  changedBy String?  // staff user id
  note      String?
  changedAt DateTime @default(now())
}

// Staff users for dashboard
model Staff {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String
  role         String   @default("operator") // 'admin', 'operator'
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
